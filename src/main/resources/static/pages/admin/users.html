<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - PhotoConnect Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .header h1 {
            color: #333;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
        }

        .search-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .users-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .btn-action {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-view {
            background: #2196F3;
            color: white;
        }

        .btn-edit {
            background: #FFC107;
            color: black;
        }

        .btn-delete {
            background: #F44336;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }

        .page-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä User Management</h1>
            <div>
                <button class="btn btn-secondary" onclick="goToDashboard()">‚Üê Dashboard</button>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="number" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <h3>Active Users</h3>
                <div class="number" id="activeUsers">0</div>
            </div>
            <div class="stat-card">
                <h3>Today's New</h3>
                <div class="number" id="newUsersToday">0</div>
            </div>
            <div class="stat-card">
                <h3>Photographers</h3>
                <div class="number" id="totalPhotographers">0</div>
            </div>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchInput" placeholder="Search by name or email..."
                onkeyup="searchUsers()">
            <button class="btn btn-primary" onclick="loadUsers()">Refresh</button>
            <button class="btn btn-secondary" onclick="exportUsers()">Export CSV</button>
        </div>

        <div class="users-table">
            <div id="loading" class="loading">Loading users...</div>
            <table id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination will be added here -->
        </div>
    </div>

    <script>
        let currentPage = 0;
        let totalPages = 0;

        // Get token from localStorage
        const token = localStorage.getItem('adminToken') || localStorage.getItem('token');

        if (!token) {
            alert('Please login first');
            window.location.href = '/pages/signin.html';
        }

        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
                    document.getElementById('newUsersToday').textContent = stats.newUsersToday || 0;
                    document.getElementById('totalPhotographers').textContent = stats.totalPhotographers || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load users with pagination
        async function loadUsers(page = 0) {
            currentPage = page;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';

            try {
                const response = await fetch(`/api/admin/users?page=${page}&size=10&sortBy=createdAt&sortDir=desc`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderUsers(data.users);
                    renderPagination(data.currentPage, data.totalPages);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('usersTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('loading').innerHTML = 'Error loading users. Please try again.';
            }
        }

        // Render users in table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');

                // Format roles
                let roles = 'User';
                if (user.roles && user.roles.length > 0) {
                    roles = Array.from(user.roles).join(', ');
                }

                // Status badge
                const statusClass = user.enabled ? 'badge-success' : 'badge-danger';
                const statusText = user.enabled ? 'Active' : 'Inactive';

                // Format date
                const joinDate = new Date(user.createdAt).toLocaleDateString();

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${roles}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${joinDate}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-action btn-view" onclick="viewUser(${user.id})">View</button>
                            <button class="btn-action btn-edit" onclick="editUser(${user.id})">Edit</button>
                            <button class="btn-action ${user.enabled ? 'btn-delete' : 'btn-edit'}" 
                                    onclick="toggleUserStatus(${user.id}, ${!user.enabled})">
                                ${user.enabled ? 'Disable' : 'Enable'}
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Render pagination
        function renderPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            if (currentPage > 0) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.onclick = () => loadUsers(currentPage - 1);
                paginationDiv.appendChild(prevBtn);
            }

            // Page numbers
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 5);

            for (let i = startPage; i < endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i + 1;
                pageBtn.onclick = () => loadUsers(i);
                paginationDiv.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages - 1) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = () => loadUsers(currentPage + 1);
                paginationDiv.appendChild(nextBtn);
            }
        }

        // Search users
        async function searchUsers() {
            const keyword = document.getElementById('searchInput').value.trim();

            if (keyword.length === 0) {
                loadUsers();
                return;
            }

            if (keyword.length < 2) return;

            try {
                const response = await fetch(`/api/admin/users/search?keyword=${encodeURIComponent(keyword)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('usersTable').style.display = 'table';

                    // Render search results
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '';

                    if (!users || users.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    No users found matching "${keyword}"
                                </td>
                            </tr>
                        `;
                        document.getElementById('pagination').innerHTML = '';
                        return;
                    }

                    users.forEach(user => {
                        const row = document.createElement('tr');
                        // Same rendering logic as above
                        // ... (copy from renderUsers function)
                    });

                    document.getElementById('pagination').innerHTML = `
                        <button class="btn btn-primary" onclick="loadUsers()">Show All Users</button>
                    `;
                }
            } catch (error) {
                console.error('Error searching users:', error);
            }
        }

        // Toggle user status
        async function toggleUserStatus(userId, enable) {
            const action = enable ? 'enable' : 'disable';
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert(`User ${action}d successfully`);
                    loadUsers(currentPage); // Refresh current page
                } else {
                    alert('Failed to update user status');
                }
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error updating user status');
            }
        }

        // View user details
        function viewUser(userId) {
            alert(`View user ${userId} - Implement this feature`);
            // You can redirect to user detail page or show modal
        }

        // Edit user
        function editUser(userId) {
            alert(`Edit user ${userId} - Implement this feature`);
            // You can open edit modal
        }

        // Export users to CSV
        function exportUsers() {
            alert('Export feature will be implemented');
        }

        // Go back to dashboard
        function goToDashboard() {
            window.location.href = '/pages/dashboards/admin.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
            loadUsers();
        });
    </script>
</body>

</html>